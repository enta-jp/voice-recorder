<!DOCTYPE html>
<html class="light" lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>Voice Recorder</title>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#137fec",
                    "recording": "#ef4444",
                    "background-light": "#f6f7f8",
                    "background-dark": "#101922",
                },
                fontFamily: {
                    "display": ["Inter", "Noto Sans JP", "sans-serif"]
                },
                borderRadius: {"DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px"},
            },
        },
    }
</script>
<style>
    body {
        min-height: 100dvh;
        overscroll-behavior: none;
        -webkit-font-smoothing: antialiased;
    }
    
    @keyframes pulse-ring {
        0% { transform: scale(1); opacity: 0.6; }
        50% { transform: scale(1.15); opacity: 0.3; }
        100% { transform: scale(1.3); opacity: 0; }
    }
    
    @keyframes wave-animate {
        0%, 100% { height: 0.75rem; }
        50% { height: var(--wave-height); }
    }
    
    .pulse-ring {
        animation: pulse-ring 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    .wave-bar {
        animation: wave-animate 0.8s ease-in-out infinite;
        animation-delay: var(--delay);
    }
    
    .recording-pulse {
        animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    /* Safe area for iPhone notch/home indicator */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
        .safe-bottom {
            padding-bottom: calc(2.5rem + env(safe-area-inset-bottom));
        }
    }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#111418] dark:text-white font-display overflow-x-hidden touch-manipulation">
<div class="relative flex h-full min-h-screen w-full flex-col">
    <!-- Header -->
    <div class="flex items-center p-4 pb-2 justify-between z-10">
        <div class="w-12 h-12 flex items-center justify-center opacity-0 pointer-events-none"></div>
        <h2 class="text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">ボイスレコーダー</h2>
        <button id="settingsBtn" class="w-12 h-12 flex items-center justify-center text-[#111418] dark:text-white rounded-full hover:bg-black/5 dark:hover:bg-white/10 transition-colors active:scale-95">
            <span class="material-symbols-outlined">settings</span>
        </button>
    </div>
    
    <!-- Folder Selection -->
    <div class="flex justify-center w-full px-4 pt-2 pb-6 z-10">
        <button id="folderBtn" class="flex h-10 shrink-0 items-center justify-center gap-x-3 rounded-full bg-white dark:bg-[#1e2a35] pl-5 pr-4 shadow-sm border border-[#e5e7eb] dark:border-[#2a3845] active:scale-95 transition-transform">
            <span class="material-symbols-outlined text-primary text-[20px]">folder_open</span>
            <p id="folderName" class="text-sm font-medium leading-normal truncate max-w-[200px]">保存先: /マイドライブ/Voice Memos</p>
            <span class="material-symbols-outlined text-[#637588] text-[20px]">arrow_drop_down</span>
        </button>
    </div>
    
    <!-- Timer Section -->
    <div class="flex flex-col items-center justify-center pt-4 pb-8">
        <div class="flex gap-2 items-end">
            <!-- Minutes -->
            <div class="flex flex-col items-center gap-2">
                <div class="flex h-20 w-16 items-center justify-center rounded-2xl bg-white dark:bg-[#1e2a35] shadow-sm border border-[#e5e7eb] dark:border-[#2a3845]">
                    <p id="minutes" class="text-3xl font-bold leading-tight tracking-[-0.015em] font-mono">00</p>
                </div>
            </div>
            <div class="h-20 flex items-center justify-center pb-1">
                <span class="text-2xl font-bold text-[#637588]">:</span>
            </div>
            <!-- Seconds -->
            <div class="flex flex-col items-center gap-2">
                <div class="flex h-20 w-16 items-center justify-center rounded-2xl bg-white dark:bg-[#1e2a35] shadow-sm border border-[#e5e7eb] dark:border-[#2a3845]">
                    <p id="seconds" class="text-3xl font-bold leading-tight tracking-[-0.015em] font-mono">00</p>
                </div>
            </div>
        </div>
        <p class="text-[#637588] text-xs font-medium mt-3 tracking-wide uppercase">Recording Time</p>
    </div>
    
    <!-- Waveform Visualization -->
    <div id="waveform" class="flex items-center justify-center h-16 gap-1 w-full px-12 opacity-50">
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 0.75rem; --delay: 0s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 1.25rem; --delay: 0.1s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 2rem; --delay: 0.2s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 1rem; --delay: 0.3s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 1.5rem; --delay: 0.4s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 2.5rem; --delay: 0.5s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 1.25rem; --delay: 0.6s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 0.75rem; --delay: 0.7s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 2rem; --delay: 0.8s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 3rem; --delay: 0.9s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 1.5rem; --delay: 1s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 1rem; --delay: 1.1s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 2rem; --delay: 1.2s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 0.75rem; --delay: 1.3s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 1.25rem; --delay: 1.4s;"></div>
        <div class="wave-bar w-1.5 bg-primary rounded-full" style="--wave-height: 0.5rem; --delay: 1.5s;"></div>
    </div>
    
    <!-- Status Text -->
    <div class="py-4">
        <h2 id="statusTitle" class="text-[#111418] dark:text-white tracking-tight text-[22px] font-bold leading-tight px-4 text-center">待機中</h2>
        <p id="statusSubtitle" class="text-[#637588] text-sm text-center mt-1">タップして録音を開始</p>
    </div>
    
    <!-- Main Action Area -->
    <div class="flex-1 flex items-center justify-center py-6 min-h-[180px]">
        <div class="relative flex items-center justify-center">
            <div id="ring1" class="absolute inset-0 bg-primary/10 dark:bg-primary/20 rounded-full scale-125 transition-all duration-300"></div>
            <div id="ring2" class="absolute inset-0 bg-primary/20 dark:bg-primary/30 rounded-full scale-110 transition-all duration-300"></div>
            <button id="recordBtn" class="relative flex w-24 h-24 md:w-28 md:h-28 items-center justify-center rounded-full bg-primary text-white shadow-xl shadow-primary/30 hover:bg-[#1170d2] active:scale-95 transition-all duration-200 z-10 group">
                <span id="recordIcon" class="material-symbols-outlined text-[40px] md:text-[48px] group-hover:scale-110 transition-transform">mic</span>
            </button>
        </div>
    </div>
    
    <!-- Bottom Action Bar - 修正: pb-10 → pb-20 で約1cm上に移動 -->
    <div class="p-6 pb-20 safe-bottom w-full bg-transparent">
        <button id="uploadBtn" class="w-full h-14 rounded-full bg-[#e5e7eb] dark:bg-[#2a3845] text-[#9ca3af] dark:text-[#637588] font-bold text-base tracking-[0.015em] flex items-center justify-center gap-3 cursor-not-allowed transition-all duration-300" disabled>
            <span class="material-symbols-outlined text-[20px]">cloud_upload</span>
            <span id="uploadText">ドライブへ送信</span>
        </button>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-white dark:bg-[#1e2a35] rounded-3xl max-w-md w-full p-6 shadow-2xl">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold">設定</h3>
            <button id="closeSettings" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-black/5 dark:hover:bg-white/10">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-2">GAS WebアプリURL</label>
                <input id="gasUrl" type="url" placeholder="https://script.google.com/macros/s/..." class="w-full px-4 py-3 rounded-xl bg-background-light dark:bg-[#101922] border border-[#e5e7eb] dark:border-[#2a3845] focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <div>
                <label class="block text-sm font-medium mb-2">保存先フォルダ名</label>
                <input id="folderInput" type="text" placeholder="Voice Memos" value="Voice Memos" class="w-full px-4 py-3 rounded-xl bg-background-light dark:bg-[#101922] border border-[#e5e7eb] dark:border-[#2a3845] focus:outline-none focus:ring-2 focus:ring-primary">
            </div>
            <button id="saveSettings" class="w-full h-12 rounded-full bg-primary text-white font-bold hover:bg-[#1170d2] active:scale-95 transition-all">
                保存
            </button>
        </div>
    </div>
</div>

<script>
// Configuration
let GAS_WEB_APP_URL = '';
let FOLDER_NAME = 'Voice Memos';

// Load settings from localStorage
function loadSettings() {
    const savedUrl = localStorage.getItem('gasUrl');
    const savedFolder = localStorage.getItem('folderName');
    if (savedUrl) {
        GAS_WEB_APP_URL = savedUrl;
        document.getElementById('gasUrl').value = savedUrl;
    }
    if (savedFolder) {
        FOLDER_NAME = savedFolder;
        document.getElementById('folderInput').value = savedFolder;
        document.getElementById('folderName').textContent = `保存先: /マイドライブ/${savedFolder}`;
    }
}

// Save settings
function saveSettings() {
    const url = document.getElementById('gasUrl').value.trim();
    const folder = document.getElementById('folderInput').value.trim();
    if (url) {
        GAS_WEB_APP_URL = url;
        localStorage.setItem('gasUrl', url);
    }
    if (folder) {
        FOLDER_NAME = folder;
        localStorage.setItem('folderName', folder);
        document.getElementById('folderName').textContent = `保存先: /マイドライブ/${folder}`;
    }
    closeSettingsModal();
    showStatus('設定を保存しました', '');
}

// State
let mediaRecorder = null;
let audioChunks = [];
let recordingStartTime = null;
let timerInterval = null;
let audioBlob = null;

// Elements
const recordBtn = document.getElementById('recordBtn');
const recordIcon = document.getElementById('recordIcon');
const uploadBtn = document.getElementById('uploadBtn');
const uploadText = document.getElementById('uploadText');
const statusTitle = document.getElementById('statusTitle');
const statusSubtitle = document.getElementById('statusSubtitle');
const minutesDisplay = document.getElementById('minutes');
const secondsDisplay = document.getElementById('seconds');
const ring1 = document.getElementById('ring1');
const ring2 = document.getElementById('ring2');
const waveform = document.getElementById('waveform');
const settingsBtn = document.getElementById('settingsBtn');
const settingsModal = document.getElementById('settingsModal');
const closeSettings = document.getElementById('closeSettings');
const saveSettingsBtn = document.getElementById('saveSettings');

// Initialize
loadSettings();

// Settings Modal
settingsBtn.addEventListener('click', () => {
    settingsModal.classList.remove('hidden');
    settingsModal.classList.add('flex');
});

closeSettings.addEventListener('click', closeSettingsModal);
saveSettingsBtn.addEventListener('click', saveSettings);

settingsModal.addEventListener('click', (e) => {
    if (e.target === settingsModal) closeSettingsModal();
});

function closeSettingsModal() {
    settingsModal.classList.add('hidden');
    settingsModal.classList.remove('flex');
}

// Recording functions
async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                audioChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            stream.getTracks().forEach(track => track.stop());
            enableUpload();
        };
        
        mediaRecorder.start();
        recordingStartTime = Date.now();
        startTimer();
        updateUIForRecording(true);
        showStatus('録音中', '停止するにはもう一度タップ');
        
    } catch (error) {
        console.error('録音エラー:', error);
        showStatus('エラー', 'マイクへのアクセスが拒否されました');
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        stopTimer();
        updateUIForRecording(false);
        showStatus('録音完了', 'ドライブへ送信できます');
    }
}

function startTimer() {
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        minutesDisplay.textContent = String(minutes).padStart(2, '0');
        secondsDisplay.textContent = String(seconds).padStart(2, '0');
    }, 1000);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

function updateUIForRecording(isRecording) {
    if (isRecording) {
        recordBtn.classList.remove('bg-primary', 'hover:bg-[#1170d2]');
        recordBtn.classList.add('bg-recording', 'recording-pulse');
        recordIcon.textContent = 'stop';
        ring1.classList.add('pulse-ring');
        ring2.classList.add('pulse-ring');
        waveform.style.opacity = '1';
    } else {
        recordBtn.classList.add('bg-primary', 'hover:bg-[#1170d2]');
        recordBtn.classList.remove('bg-recording', 'recording-pulse');
        recordIcon.textContent = 'mic';
        ring1.classList.remove('pulse-ring');
        ring2.classList.remove('pulse-ring');
        waveform.style.opacity = '0.5';
    }
}

function enableUpload() {
    uploadBtn.disabled = false;
    uploadBtn.classList.remove('bg-[#e5e7eb]', 'dark:bg-[#2a3845]', 'text-[#9ca3af]', 'dark:text-[#637588]', 'cursor-not-allowed');
    uploadBtn.classList.add('bg-primary', 'text-white', 'cursor-pointer', 'hover:bg-[#1170d2]', 'active:scale-95');
}

function disableUpload() {
    uploadBtn.disabled = true;
    uploadBtn.classList.add('bg-[#e5e7eb]', 'dark:bg-[#2a3845]', 'text-[#9ca3af]', 'dark:text-[#637588]', 'cursor-not-allowed');
    uploadBtn.classList.remove('bg-primary', 'text-white', 'cursor-pointer', 'hover:bg-[#1170d2]');
}

function showStatus(title, subtitle) {
    statusTitle.textContent = title;
    statusSubtitle.textContent = subtitle;
}

async function uploadToGoogleDrive() {
    if (!audioBlob) return;
    
    if (!GAS_WEB_APP_URL) {
        showStatus('エラー', '設定でGAS URLを入力してください');
        return;
    }
    
    showStatus('アップロード中...', 'しばらくお待ちください');
    uploadText.textContent = 'アップロード中...';
    disableUpload();
    
    try {
        // Convert blob to base64
        const reader = new FileReader();
        reader.readAsDataURL(audioBlob);
        
        reader.onloadend = async () => {
            const base64Audio = reader.result.split(',')[1];
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `voice_memo_${timestamp}.webm`;
            
            const payload = {
                audio: base64Audio,
                filename: filename,
                folder: FOLDER_NAME,
                mimeType: 'audio/webm'
            };
            
            const response = await fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });
            
            // Note: no-cors mode means we can't read the response
            // We'll assume success if no error is thrown
            showStatus('送信完了!', 'ドライブに保存されました');
            uploadText.textContent = '送信完了!';
            
            setTimeout(() => {
                resetApp();
            }, 2000);
            
        };
    } catch (error) {
        console.error('アップロードエラー:', error);
        showStatus('エラー', 'アップロードに失敗しました');
        uploadText.textContent = 'ドライブへ送信';
        enableUpload();
    }
}

function resetApp() {
    audioBlob = null;
    audioChunks = [];
    minutesDisplay.textContent = '00';
    secondsDisplay.textContent = '00';
    showStatus('待機中', 'タップして録音を開始');
    uploadText.textContent = 'ドライブへ送信';
    disableUpload();
}

// Event Listeners
recordBtn.addEventListener('click', () => {
    if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        startRecording();
    } else {
        stopRecording();
    }
});

uploadBtn.addEventListener('click', uploadToGoogleDrive);

// Prevent scrolling on mobile
document.body.addEventListener('touchmove', (e) => {
    if (e.target.closest('input, textarea, select')) return;
    e.preventDefault();
}, { passive: false });
</script>
</body>
</html>
